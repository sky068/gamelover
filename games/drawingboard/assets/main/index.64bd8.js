window.__require=function t(i,o,r){function e(s,h){if(!o[s]){if(!i[s]){var a=s.split("/");if(a=a[a.length-1],!i[a]){var p="function"==typeof __require&&__require;if(!h&&p)return p(a,!0);if(n)return n(a,!0);throw new Error("Cannot find module '"+s+"'")}s=a}var l=o[s]={exports:{}};i[s][0].call(l.exports,function(t){return e(i[s][1][t]||t)},l,l.exports,t,i,o,r)}return o[s].exports}for(var n="function"==typeof __require&&__require,s=0;s<r.length;s++)e(r[s]);return e}({DrawingBoard:[function(t,i,o){"use strict";cc._RF.push(i,"2e8d2n1khFBWb8oCWax7o8C","DrawingBoard"),Object.defineProperty(o,"__esModule",{value:!0});var r=function(){function t(t,i,o){this.init(t,i,o)}return Object.defineProperty(t.prototype,"width",{get:function(){return this._witdh},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),t.prototype.init=function(t,i,o){this.tempColor=this.tempR=this.tempG=this.tempB=this.tempA=0,this.curColor=0,this._witdh=Math.round(t),this._height=Math.round(i),this.initPointColor(),this.initMaskPoint(),this.initPixelColor(),this.initLineData(),o&&this.setData(o)},t.prototype.initPointColor=function(){this.pointColor||(this.pointColor=[]);for(var t=0;t<this.width;++t){this.pointColor[t]||(this.pointColor[t]=[]);for(var i=0;i<this.height;++i)this.pointColor[t][i]=0}this.colorCount={},this.colorCount[0]=this.width*this.height},t.prototype.initMaskPoint=function(){this.maskPoint||(this.maskPoint=[]);for(var t=0;t<this.width;++t){this.maskPoint[t]||(this.maskPoint[t]=[]);for(var i=0;i<this.height;++i)this.maskPoint[t][i]=1}},t.prototype.initPixelColor=function(){this.buffer=new ArrayBuffer(this.width*this.height*4),this.pixelColor=new Uint8Array(this.buffer),this.pixelColor.fill(0)},t.prototype.reset=function(){this.resetPointColor(),this.resetMaskPoint(),this.resetPixelColor()},t.prototype.resetPointColor=function(){for(var t=this.width-1;t>=0;--t)for(var i=this.height-1;i>=0;--i)this.pointColor[t][i]=0;for(var o in this.colorCount)this.colorCount[o]=0},t.prototype.resetMaskPoint=function(){for(var t=this.width-1;t>=0;--t)for(var i=this.height-1;i>=0;--i)this.maskPoint[t][i]=1},t.prototype.resetPixelColor=function(){this.pixelColor.fill(0)},t.prototype.setData=function(t){var i=new Uint8Array(t);i.length==this.width*this.height*4?(this.setPixelColorByRGBA(i),this.setPointColorByRGBA(i)):console.warn("\u753b\u677f\u8bbe\u7f6e\u6570\u636e\u5931\u8d25\uff0c\u6570\u636e\u957f\u5ea6\u4e0e\u753b\u677f\u5927\u5c0f\u4e0d\u4e00\u81f4\u3002")},t.prototype.setPixelColorByRGBA=function(t){this.pixelColor.set(t)},t.prototype.setPointColorByRGBA=function(t){this.colorCount={};for(var i=0;i<this.height;++i)for(var o=i*this.height,r=0;r<this.width;++r){var e=this.convertToNumber(t[o++],t[o++],t[o++],t[o++]);this.pointColor[r][i]=e,this.colorCount[e]?this.colorCount[e]+=1:this.colorCount[e]=1}},t.prototype.setMask=function(t){for(var i=this.width-1;i>=0;--i)if(t[i])for(var o=this.height-1;o>=0;--o)null!=t[i][o]&&(this.maskPoint[i][o]=t[i][o])},t.prototype.setDisable=function(){for(var t=this.width-1;t>=0;--t)for(var i=this.height-1;i>=0;--i)this.maskPoint[t][i]=0},t.prototype.addEnablePoints=function(t){for(var i=this.width-1;i>=0;--i)if(t[i])for(var o=this.height-1;o>=0;--o)t[i][o]&&(this.maskPoint[i][o]=t[i][o])},t.prototype.copyData=function(t){void 0===t&&(t=[]);for(var i=0,o=this.pixelColor.length;i<o;++i)t[i]=this.pixelColor[i];return t},t.prototype.getData=function(){return this.pixelColor},t.prototype.getBuffer=function(){return this.buffer},t.prototype.getPointData=function(){return this.pointColor},t.prototype.getColorCount=function(t,i,o,r){void 0===r&&(r=255);var e=this.convertToNumber(t,i,o,r);return this.colorCount[e]},t.prototype.setColor=function(t,i,o,r){void 0===r&&(r=255),this.curColor=this.convertToNumber(t,i,o,r),this.colorCount[this.curColor]||(this.colorCount[this.curColor]=0),this.tempColor=this.curColor,this.tempR=t,this.tempG=i,this.tempB=o,this.tempA=r},t.prototype.clear=function(){this.reset()},t.prototype.initLineData=function(){this.previousLineEndPos=new e,this.previousLineEndPosT=new e,this.previousLineEndPosB=new e,this.previousLineCircleEnd=!0,this.previousLineWidth=1},t.prototype.moveTo=function(t,i){t=Math.round(t),i=Math.round(i),this.previousLineEndPos.set(t,i),this.previousLineEndPosT.set(t,i),this.previousLineEndPosB.set(t,i)},t.prototype.setLineWidth=function(t){this.previousLineWidth=t},t.prototype.setLineCircleEnd=function(t){this.previousLineCircleEnd=t},t.prototype.line=function(t,i,o,r){if(t=Math.round(t),o=Math.round(o),i=Math.round(i),r=Math.round(r),t!=o||i!=r){var n=this.previousLineWidth,s=this.previousLineCircleEnd;this.previousLineEndPos.set(o,r);var h=0,a=0,p=1;if(t==o)h=Math.round(.5*n);else if(i==r)a=Math.round(.5*n);else{var l=(r-i)/(o-t);a=.5*n/(p=Math.sqrt(l*l+1)),h=Math.round(a*l),a=Math.round(a)}this.previousLineEndPosT.set(o-h,r+a),this.previousLineEndPosB.set(o+h,r-a);var u=new e(t,i),d=new e(o,r);t>o&&(u.x=o,u.y=r,d.x=t,d.y=i),this._drawLine(u,d,n,h,a,p),s&&(this._drawCircle(t,i,.5*n),this._drawCircle(o,r,.5*n))}},t.prototype.lineTo=function(t,i){if(t=Math.round(t),i=Math.round(i),this.previousLineEndPos.x!=t||this.previousLineEndPos.y!=i){var o=this.previousLineWidth,r=this.previousLineCircleEnd,n=this.previousLineEndPos.x,s=this.previousLineEndPos.y,h=t,a=i;n>h&&(n=h,s=a,h=this.previousLineEndPos.x,a=this.previousLineEndPos.y);var p=0,l=0,u=1;if(n==h)p=Math.round(.5*o);else if(s==a)l=Math.round(.5*o);else{var d=(a-s)/(h-n);l=.5*o/(u=Math.sqrt(d*d+1)),p=Math.round(l*d),l=Math.round(l)}if(r)this._drawCircle(n,s,.5*o),this._drawCircle(h,a,.5*o);else if(this.previousLineEndPos.x!=this.previousLineEndPosT.x||this.previousLineEndPos.y!=this.previousLineEndPosT.y){var c=new e(this.previousLineEndPos.x-p,this.previousLineEndPos.y+l),y=new e(this.previousLineEndPos.x+p,this.previousLineEndPos.y-l);this._drawTriangle([c,y,this.previousLineEndPosT]),this._drawTriangle([c,y,this.previousLineEndPosB])}this._drawLine(new e(n,s),new e(h,a),o,p,l,u),this.previousLineEndPos.set(t,i),this.previousLineEndPosT.set(t-p,i+l),this.previousLineEndPosB.set(t+p,i-l)}},t.prototype._drawLine=function(t,i,o,r,n,s){if(t.y==i.y){var h=t.x<i.x?t.x:i.x;this._drawRect(new e(h,Math.round(t.y-.5*o)),Math.abs(t.x-i.x),o)}else if(t.x==i.x){var a=t.y<i.y?t.y:i.y;this._drawRect(new e(Math.round(t.x-.5*o),a),o,Math.abs(t.y-i.y))}else{var p=(t.x-i.x)/(t.y-i.y),l=new e(t.x-r,t.y+n),u=new e(t.x+r,t.y-n),d=new e(i.x-r,i.y+n),c=new e(i.x+r,i.y-n),y=new e,f=new e,w=Math.round(o*s);i.y>t.y?u.x<d.x?(y.x=u.x,y.y=u.y+w,f.x=d.x,f.y=d.y-w,this._drawVerticalTriangle(y,u,l),this._drawParallelogram(u,f,w),this._drawVerticalTriangle(d,f,c)):(y.x=u.x,y.y=Math.round(d.y-(y.x-d.x)*p),f.x=d.x,f.y=Math.round(u.y+(u.x-f.x)*p),this._drawVerticalTriangle(d,f,l),this._drawParallelogram(f,u,d.y-f.y),this._drawVerticalTriangle(y,u,c)):l.x<c.x?(y.x=l.x,y.y=l.y-w,f.x=c.x,f.y=c.y+w,this._drawVerticalTriangle(l,y,u),this._drawParallelogram(y,c,w),this._drawVerticalTriangle(f,c,d)):(y.x=l.x,y.y=Math.round(c.y-(y.x-c.x)*p),f.x=c.x,f.y=Math.round(l.y+(l.x-f.x)*p),this._drawVerticalTriangle(f,c,u),this._drawParallelogram(c,y,l.y-y.y),this._drawVerticalTriangle(l,y,d))}},t.prototype.rect=function(t,i,o,r){t=Math.round(t),i=Math.round(i),this._drawRect(new e(t,i),o,r)},t.prototype._drawRect=function(t,i,o){for(var r=this.clampX(t.x),e=this.clampX(t.x+i),n=this.clampY(t.y),s=this.clampY(t.y+o),h=n;h<=s;++h)this._drawRowPixel(r,e,h)},t.prototype._drawParallelogram=function(t,i,o){if(t.x!=i.x)for(var r=(i.y-t.y)/(i.x-t.x),e=this._minX(t.x),n=this._maxX(i.x),s=e;s<=n;++s){var h=t.y+Math.round((s-t.x)*r),a=h+o;h=this._minY(h),a=this._maxY(a),this._drawColPixel(h,a,s)}},t.prototype.triangle=function(t,i,o,r,n,s){t=Math.round(t),i=Math.round(i),o=Math.round(o),r=Math.round(r),n=Math.round(n),s=Math.round(s);var h=[];h.push(new e(t,i)),h.push(new e(o,r)),h.push(new e(n,s)),this._drawTriangle(h)},t.prototype._drawTriangle=function(t){t.sort(function(t,i){return t.x-i.x});var i=t[0],o=t[1],r=t[2];if(i.x==o.x){if(i.x==r.x)return;return i.y<o.y&&(i=t[1],o=t[0]),void this._drawVerticalTriangle(i,o,r)}var n=(r.y-i.y)/(r.x-i.x),s=new e(o.x,Math.round(i.y+(o.x-i.x)*n));s.y!=o.y&&(s.y<o.y?(this._drawVerticalTriangle(o,s,i),this._drawVerticalTriangle(o,s,r)):(this._drawVerticalTriangle(s,o,i),this._drawVerticalTriangle(s,o,r)))},t.prototype._drawVerticalTriangle=function(t,i,o){if(o.x!=t.x){var r=(o.y-t.y)/(o.x-t.x),e=(o.y-i.y)/(o.x-i.x),n=o.x,s=t.x;n<s&&(n=t.x,s=o.x),s=this._minX(s),n=this._maxX(n);for(var h=s;h<=n;++h){var a=this.clampY(Math.round(t.y+(h-t.x)*r)),p=this.clampY(Math.round(i.y+(h-i.x)*e));this._drawColPixel(p,a,h)}}},t.prototype.circle=function(t,i,o){t=Math.round(t),i=Math.round(i),this._drawCircle(t,i,o)},t.prototype._drawCircle=function(t,i,o){if(0!=(o=Math.round(o)))for(var r=o*o,e=this.clampY(i-o),n=this.clampY(i+o),s=e;s<=n;++s){var h=s-i;h=Math.round(Math.sqrt(r-h*h));var a=this.clampX(t-h),p=this.clampX(t+h);this._drawRowPixel(a,p,s)}},t.prototype._minX=function(t){return t>=0?t:0},t.prototype._maxX=function(t){return t<this.width?t:this.width-1},t.prototype._minY=function(t){return t>=0?t:0},t.prototype._maxY=function(t){return t<this.height?t:this.height-1},t.prototype.clampX=function(t){return t<0?0:t>=this.width?this.width-1:t},t.prototype.clampY=function(t){return t<0?0:t>=this.height?this.height-1:t},t.prototype._drawPixel=function(t,i){if(t=Math.round(t),i=Math.round(i),0!=this.maskPoint[t][i]&&this.pointColor[t][i]!=this.tempColor){var o=4*(i*this.width+t);this.pixelColor[o]=this.tempR,this.pixelColor[o+1]=this.tempG,this.pixelColor[o+2]=this.tempB,this.pixelColor[o+3]=this.tempA;var r=this.pointColor[t][i];this.colorCount[r]--,this.colorCount[this.tempColor]++,this.pointColor[t][i]=this.tempColor}},t.prototype._drawRowPixel=function(t,i,o){for(var r=4*(o*this.width+t),e=t;e<=i;++e){if(0!=this.maskPoint[e][o]&&this.pointColor[e][o]!=this.tempColor){this.pixelColor[r]=this.tempR,this.pixelColor[r+1]=this.tempG,this.pixelColor[r+2]=this.tempB,this.pixelColor[r+3]=this.tempA;var n=this.pointColor[e][o];this.colorCount[n]--,this.colorCount[this.tempColor]++,this.pointColor[e][o]=this.tempColor}r+=4}},t.prototype._drawColPixel=function(t,i,o){for(var r=4*(t*this.width+o),e=t;e<=i;++e){if(0!=this.maskPoint[o][e]&&this.pointColor[o][e]!=this.tempColor){this.pixelColor[r]=this.tempR,this.pixelColor[r+1]=this.tempG,this.pixelColor[r+2]=this.tempB,this.pixelColor[r+3]=this.tempA;var n=this.pointColor[o][e];this.colorCount[n]--,this.colorCount[this.tempColor]++,this.pointColor[o][e]=this.tempColor}r+=4*this.width}},t.prototype.convertToNumber=function(t,i,o,r){return void 0===r&&(r=255),(254&t)<<23|i<<16|o<<8|r},t.prototype.convertToRGBA=function(t){return{r:(4009754624&t)>>23,g:(16711680&t)>>16,b:(65280&t)>>8,a:255&t}},t}();o.default=r;var e=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}return t.prototype.set=function(t,i){"number"==typeof t?(this.x=t,this.y=i):(this.x=t.x,this.y=t.y)},t}();cc._RF.pop()},{}],Game:[function(t,i,o){"use strict";cc._RF.push(i,"1c26dVSok5E7o2PwD2sGBJa","Game");var r,e=this&&this.__extends||(r=function(t,i){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var o in i)i.hasOwnProperty(o)&&(t[o]=i[o])})(t,i)},function(t,i){function o(){this.constructor=t}r(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}),n=this&&this.__decorate||function(t,i,o,r){var e,n=arguments.length,s=n<3?i:null===r?r=Object.getOwnPropertyDescriptor(i,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,i,o,r);else for(var h=t.length-1;h>=0;h--)(e=t[h])&&(s=(n<3?e(s):n>3?e(i,o,s):e(i,o))||s);return n>3&&s&&Object.defineProperty(i,o,s),s};Object.defineProperty(o,"__esModule",{value:!0});var s,h=t("./DrawingBoard"),a=cc._decorator,p=a.ccclass,l=a.property;(function(t){t[t.drawing=1]="drawing",t[t.erasing=2]="erasing"})(s||(s={}));var u=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.drawNode=null,i.captureCamera=null,i.db=null,i.gameState=s.drawing,i.texture=null,i.prePos=cc.Vec2.ZERO,i.lastColor=cc.Color.BLACK,i.lastLineWidth=1,i.history=[],i}return e(i,t),i.prototype.start=function(){this.initDb(),this.initTexture(),this.drawNode.on("touchstart",this.onTouchStart,this),this.drawNode.on("touchmove",this.onTouchMove,this),this.drawNode.on("touchend",this.onTouchEnd,this),this.drawNode.on("touchcancel",this.onTouchEnd,this)},i.prototype.initDb=function(){this.db=new h.default(this.drawNode.width,this.drawNode.height),this.lastLineWidth=5,this.db.setLineWidth(this.lastLineWidth),this.db.setColor(this.lastColor.r,this.lastColor.g,this.lastColor.b,this.lastColor.a),this.db.setLineCircleEnd(!0)},i.prototype.initTexture=function(){this.texture=new cc.RenderTexture,this.texture.initWithSize(this.drawNode.width,this.drawNode.height,cc.RenderTexture.DepthStencilFormat.RB_FMT_S8);var t=new cc.SpriteFrame(this.texture);this.drawNode.getComponent(cc.Sprite).spriteFrame=t},i.prototype.onTouchStart=function(t){var i=t.getLocation();this.prePos=this.convertToDrawNodePos(i),this.db.moveTo(this.prePos.x,this.prePos.y)},i.prototype.onTouchMove=function(t){var i=t.getLocation();this.prePos=this.convertToDrawNodePos(i),this.gameState==s.drawing?this.db.lineTo(this.prePos.x,this.prePos.y):this.gameState==s.erasing&&this.db.circle(this.prePos.x,this.prePos.y,10),this.drawToImg()},i.prototype.onTouchEnd=function(){this.addHistory()},i.prototype.convertToDrawNodePos=function(t){var i=this.drawNode.convertToNodeSpaceAR(t);return i.x+=this.drawNode.width*this.drawNode.anchorX,i.y+=this.drawNode.height*this.drawNode.anchorY,i.y=this.drawNode.height-i.y,i},i.prototype.addHistory=function(){var t=this.db.copyData(),i=new Uint8Array(t);this.history.push({data:i}),cc.log("\u5386\u53f2\u6b65\u9aa4: ",this.history.length)},i.prototype.drawToImg=function(){var t=this.db.getData();this.texture.initWithData(t,cc.Texture2D.PixelFormat.RGBA8888,this.db.width,this.db.height)},i.prototype.onBtnDraw=function(){this.db.setLineWidth(this.lastLineWidth),this.db.setColor(this.lastColor.r,this.lastColor.g,this.lastColor.b,this.lastColor.a),this.gameState=s.drawing},i.prototype.onBtnErase=function(){this.db.setLineWidth(3*this.lastLineWidth),this.db.setColor(255,255,255,0),this.gameState=s.erasing},i.prototype.onBtnClear=function(){this.db.reset(),this.drawToImg(),this.history.splice(0,this.history.length)},i.prototype.onBtnRevoke=function(){if(this.history.pop(),this.history.length){var t=this.history[this.history.length-1].data;this.db.setData(t.buffer),this.texture.initWithData(this.db.getData(),cc.Texture2D.PixelFormat.RGBA8888,this.db.width,this.db.height)}else this.onBtnClear();cc.log("\u5386\u53f2\u8bb0\u5f55\u5269\u4f59: ",this.history.length)},i.prototype.onBtnSave=function(){var t=this;if(cc.sys.isBrowser){var i=this.drawNode.width,o=this.drawNode.height;this.captureCamera.enabled=!0;var r=new cc.RenderTexture;r.initWithSize(i,o,cc.RenderTexture.DepthStencilFormat.RB_FMT_S8),this.captureCamera.targetTexture=r;var e=document.createElement("canvas");e.width=i,e.height=o;var n=e.getContext("2d");this.captureCamera.render();for(var s=r.readPixels(),h=4*i,a=0;a<o;a++){for(var p=o-1-a,l=n.createImageData(i,1),u=p*i*4,d=0;d<h;d++)l.data[d]=s[u+d];n.putImageData(l,0,a)}var c=e.toDataURL("image/jpg"),y=document.createElementNS("http://www.w3.org/1999/xhtml","a");y.href=c,y.download=String(Date.now())+".jpg";var f=document.createEvent("MouseEvents");f.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),y.dispatchEvent(f),this.scheduleOnce(function(){t.captureCamera.enabled=!1},.1)}else cc.warn("\u6682\u65f6\u53ea\u652f\u6301web\u7aef\u4fdd\u5b58\u56fe\u7247")},n([l(cc.Node)],i.prototype,"drawNode",void 0),n([l(cc.Camera)],i.prototype,"captureCamera",void 0),n([p],i)}(cc.Component);o.default=u,cc._RF.pop()},{"./DrawingBoard":"DrawingBoard"}]},{},["DrawingBoard","Game"]);